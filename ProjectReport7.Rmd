---
title: "Title"
author: "Andrew Fahmy, Zack Larson, Julia Lundstrum, Nikole Slinger, Dana Thacker"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(ggplot2)
library(tidyverse)
library(readxl)
library(ggthemes)
library(mapproj)

raw_data <- readxl::read_xlsx("2021VaccineCovidData.xlsx", sheet='raw_data')
VAERSdata <- readxl::read_xlsx("2021VaccineCovidData.xlsx", sheet='2021VAERSDATA')
VAERSsymptoms <- readxl::read_xlsx("2021VaccineCovidData.xlsx", sheet='2021VAERSSymptoms')
VAERSVax <- readxl::read_xlsx("2021VaccineCovidData.xlsx", sheet='2021VAERSVax')
cdcdoses <- readxl::read_xlsx("2021VaccineCovidData.xlsx", sheet='2021AllVaccines')
state <- map_data("state")
abbrev <- read.csv("csvData.csv", stringsAsFactors = FALSE)
```

### Introduction



### Background Information
(Not sure if we want to add a part for this)


### Research Questions

- Which states have the highest and lowest number of Covid-19 cases and fatality rates?
- What is the most popular vaccine manufacturer in each state?
- How do Covid-19 cases compare to the number of vaccines administered per state?
- What age group has recieved the most vaccines?
- What is the most common symptom to experience for each manufacturer?
- How does a patient's medical history compare to their symptoms after receiving the vaccine?
- What is the trend on the number of reported adverse effect from vaccines administered per day? Does the trend differ between states and nation wide?
- What patterns are shown when looking at a patient's death (post-vaccinnation) and the reasons why they might have died?

### Obtaining and Cleaning the Data



### Exploratory Analysis

**Which states have the highest and lowest number of Covid-19 cases and fatality rates?**


**What is the most popular vaccine manufacturer in each state?**


**How do Covid-19 cases compare to the number of vaccines administered per state?**


**What is the most common symptom to experience for each manufacturer?**

We then wanted to further explore the Covid-19 vaccine, specifically looking for the different symptoms that each vaccine is associated with. By joining the VAERS Vaccine data with the VAERS Symptoms data, we connected manufacturer's vaccine (Moderna, Pfizer, and Janssen) with the symptoms that patients had experienced afterwards. Rather than listing every possible symptom, we chose to focus on only the top five.

```{r, echo=FALSE}
# joining vax and symptom data, only need id, vaccine manu, and symptoms
symptoms <- VAERSVax %>% full_join(VAERSsymptoms, by = 'VAERS_ID') %>%
  filter(VAX_TYPE == 'COVID19') %>%
  select(VAERS_ID, VAX_MANU, SYMPTOM1, SYMPTOM2, SYMPTOM3, SYMPTOM4, SYMPTOM5)

moderna <- symptoms %>%
  filter(VAX_MANU == 'MODERNA')
moderna <- as.data.frame(sort(table(moderna$SYMPTOM1), decreasing = TRUE) [1:5])

pfizer <- symptoms %>%
  filter(VAX_MANU == 'PFIZER\\BIONTECH')
pfizer <- as.data.frame(sort(table(pfizer$SYMPTOM1), decreasing = TRUE) [1:5])

janssen <- symptoms %>%
  filter(VAX_MANU == 'JANSSEN')
janssen <- as.data.frame(sort(table(janssen$SYMPTOM1), decreasing = TRUE) [1:5])

ggplot(moderna, aes(x = Var1, weight = Freq)) + geom_bar(fill = 'brown3') +
  ggtitle('Most Common Symptoms from Moderna Vaccine') +
  xlab('Symptom') + ylab('Count')
```

Shown above are the reported symptoms after patients had received the Moderna vaccine. The most common symptom, chill, was reported by 1,476 people at the time our data was taken, while stiffness at the site of the vaccine injection (injection site erythema) was reported by 1,319 people. The remaining top symptoms include arthralgia (joint pain), headaches, and dizziness. Overall, symptoms from the Moderna vaccine seem relatively mild.

```{r, echo=FALSE}
ggplot(pfizer, aes(x = Var1, weight = Freq)) + geom_bar(fill = 'brown3') +
  ggtitle('Most Common Symptoms from Pfizer Vaccine') +
  xlab('Symptom') + ylab('Count')
```

When looking at the symptoms from the Pfizer vaccine pictured above, we found that the symptoms that people had experienced were somewhat similar to those from the Moderna vaccine. Again, the top symptom reported was chills with 1,421 counts, this time followed by 957 reports of arthralgia. The other top symptoms include headaches, dizziness, and Covid-19 itself which was an interesting observation. However, we can't assume Covid-19 in the patient was caused by the vaccine and one possible reason for this to occur as a symptom may have been that the patient already had Covid-19 before receiving the vaccine.

```{r, echo=FALSE}
ggplot(janssen, aes(x = Var1, weight = Freq)) + geom_bar(fill = 'brown3') +
  ggtitle('Most Common Symptoms from Janssen Vaccine') +
  xlab('Symptom') + ylab('Count')
```

Finally, we looked at the Janssen vaccine (also known as Johnson & Johnson's vaccine). Although there is less data than the Moderna and Pfizer vaccinations, we again found a similar trend in the symptoms. Like the previous vaccines, chills was the most commonly reported vaccine, which 361 patients experienced after the Janssen vaccine. The remaining top symptoms, including arthralgia, fatigue, pyrexia (fever), and headaches, were reported at a much lower count.

**What age group has experienced the most symptoms after the vaccine?**

```{r, echo=FALSE}
# joining general patient data and vax data
age <- VAERSdata %>% full_join(VAERSVax, by = 'VAERS_ID') %>%
  select(VAERS_ID, VAX_MANU, AGE_YRS)
# adding 10 year age group column to sort ages
age <- age %>%
  mutate(AGE_GROUP = ifelse(AGE_YRS %in% 0:18, '0 to 18',
                     ifelse(AGE_YRS %in% 19:29, '19 to 29',
                     ifelse(AGE_YRS %in% 30:39, '30 to 39',
                     ifelse(AGE_YRS %in% 40:49, '40 to 49',
                     ifelse(AGE_YRS %in% 50:59, '50 to 59',
                     ifelse(AGE_YRS %in% 60:69, '60 to 69',
                     ifelse(AGE_YRS %in% 70:79, '70 to 79',
                     ifelse(AGE_YRS %in% 80:89, '80 to 89', 'Over 90')))))))))
# plotting visual representation
ggplot(age, aes(x = AGE_GROUP)) + geom_bar(fill = 'darkslateblue') +
  ggtitle('Number of Vaccinations per Age Groups') +
  xlab('Age Group (years)') + ylab('Count')
```

To determine if there was a correlation between age and the likelihood of experiencing symptoms, we joined the VAERS data with the VAERS Vaccine data and split the patients into different age groups. This returned a graph with the counts of people who have experienced symptoms in each age group (divided into people under 18 followed by 10 year increments). We found that the people between 30 and 39 years old had experienced the most symptoms compared to other ages (6,083 people). On the other hand, only 242 people aged 18 years and younger were reported to have experienced symptoms. However, the low number of observations may be due to the fact that many younger people weren't eligible for the vaccine for the first few months of distribution because older people and those with health conditions were prioritized first, so there might just be a lack of data. Finally, when looking at the overall trend of the bar graph, we notice a sharp increase to the '30 to 39' age group followed by a gradual decline until it increases at the 'Over 90' group which is everyone over 99 years old that experienced symptoms.

**How does a patient's medical history compare to their symptoms after receiving the vaccine?**


**What is the trend on the number of reported adverse effect from vaccines administered per day? Does the trend differ between states and nation wide?**

To find if there are any trends in the data, we started off by joining the VAERSdata and the VAERSVax data in order to have both the date and the state in one data frame. Once we had all of the data columns we had to filter our any data that did not have to do with Covid-19. We also found that there were some dates from before 2018 that must have been mistakes to we also filtered those out.

Now we could look into any trends in the number of reports based on the date. We started off using all the samples in order to get a graph of the trend nation wide.

```{r}
# Date frame that has vaccine date, and the state it was administered in
vaxinfo <- VAERSdata %>%
    inner_join(VAERSVax, by = "VAERS_ID") %>%
    mutate(VAX_DATE = as.Date(VAX_DATE)) %>%
    filter(VAX_TYPE == "COVID19",
           VAX_DATE > as.Date("2018-01-01"),
           !is.na(STATE)) %>%
    select(VAERS_ID, VAX_DATE, STATE)


# Data frame with total of report per day
vaxinfo_daily <- vaxinfo %>%
    group_by(VAX_DATE) %>%
    summarise(DAILY_TOTAL = n())

# Data frame with total of report per day based on state
vaxinfo_daily_state <- vaxinfo %>%
    group_by(VAX_DATE, STATE) %>%
    summarise(DAILY_TOTAL = n())

# Total number of reports per state, and peak date of reports
vaxinfo_state <- vaxinfo %>%
    group_by(STATE) %>%
    summarise(TOTAL = n(), PEAK = mean(VAX_DATE))



vaxinfo_daily %>%
    filter(VAX_DATE > as.Date("2021-01-01")) %>%
    ggplot(aes(x = VAX_DATE, y = DAILY_TOTAL, color = "red")) +
    geom_line() +
    xlab("Date") +
    ylab("Number of reports") +
    ggtitle("Reports of adverse effects from vaccines in 2021")
```

Now we wanted to see what the trends looked like on a state level. To do this we grouped the rows by state and could then plot a specific state. We decided to just look at the top 10 states that has the highest numbers of reports.

```{r}
sorted_states <- vaxinfo_state %>% arrange(TOTAL) %>% select(STATE, TOTAL)
#tail(sorted_states, 10)

vaxinfo_daily_state %>%
    filter(VAX_DATE > as.Date("2020-12-01"), STATE %in% tail(sorted_states$STATE, 10)) %>%
    ggplot(aes(x = VAX_DATE, y = DAILY_TOTAL, color = STATE)) +
    geom_line() +
    facet_wrap(.~STATE) +
    xlab("Date reported") +
    ylab("Daily cases reported") +
    ggtitle("States with the most number of reports")
```

We also created a choropleth map to visualize the number of reports each state had, as well as a map to show when the peak date of the number of reports.

```{r}
# Get data in the same format so they can be joined
cdcdoses1 <- cdcdoses %>%
    mutate(State = tolower(State), Vaccinated = `Fully Vaccinated in March`)

# Join state names, abbreviations, vaccine doses, and map data
dat <- abbrev %>%
    mutate(State = tolower(State)) %>%
    left_join(state, by = c("State" = "region")) %>%
    right_join(vaxinfo_state, by = c("Code" = "STATE")) %>%
    right_join(cdcdoses1, by = "State")


ggplot(dat, aes(x = long, y = lat)) +
    geom_polygon(aes(group = group, fill = TOTAL / Vaccinated), color = "white", size = 0.1) +
    scale_fill_gradient(low = "#01c40e", high = "#ff0000") +
    coord_map() +
    theme_map() +
    ggtitle("Reports adjusted for number of vaccines administered")

ggplot(dat, aes(x = long, y = lat, group = group, fill = PEAK)) +
    geom_polygon(color = "white", size = 0.1) +
    coord_map() +
    theme_map() +
    ggtitle("Peak date of reports")
```
**What patterns are shown when looking at a patient's death (post-vaccinnation) and the reasons why they might have died?**


### Challenges Faced

One of the first challenges that we faced was that our questions that we had proposed did not line up with the data that we had. Once we had started doing data analysis we realized that what was in the data would not be able to answer the original question. In order to remedy that problem, we re-framed the original question so that we could answer it with the data that we had collected.

The next challenge that we faced was working with the data. We used multiple different data sets, some of which had multiple different sheets. This meant that to answer the questions we had, a lot of the time we would have to combine data sets that had information that pertained to it. Many times that data was not in the same format, so we would have to mutate it into a format that match. Another issue with the data was that it was not always in a structured format. This meant that we had to parse the data manually and extract the important information in whatever format it was in. One example of this was in the data about the patients with Covid-19. We wanted to look at the symptoms that they had, but the all the information was notes from the doctors in a single string. The notes has not format or structure, so to get a list of symptoms we had to parse that string.


### Conclusion



### Personal Contributions



### Works Cited








