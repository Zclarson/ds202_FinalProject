---
title: "Title"
author: "Andrew Fahmy, Zack Larson, Julia Lundstrum, Nikole Slinger, Dana Thacker"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(ggplot2)
library(tidyverse)
library(readxl)
library(ggthemes)
library(mapproj)
library(DT)

raw_data <- readxl::read_xlsx("2021VaccineCovidData.xlsx", sheet='raw_data')
VAERSdata <- readxl::read_xlsx("2021VaccineCovidData.xlsx", sheet='2021VAERSDATA')
VAERSsymptoms <- readxl::read_xlsx("2021VaccineCovidData.xlsx", sheet='2021VAERSSymptoms')
VAERSVax <- readxl::read_xlsx("2021VaccineCovidData.xlsx", sheet='2021VAERSVax')
cdcdoses <- readxl::read_xlsx("2021VaccineCovidData.xlsx", sheet='2021AllVaccines')
state <- map_data("state")
abbrev <- read.csv("csvData.csv", stringsAsFactors = FALSE)
```

### Introduction
Covid-19 has been on everyone's mind since it originally came to the United States in the earlier months of 2020. In late 2020 and early 2021, the vaccine finished all clinical trials and phases of testing and distribution began, starting with the most vulnerable populations of people. The Covid-19 vaccines are groundbreaking because they are the fastest vaccines ever created. We decided to look at data regarding the COVID vaccines because this is the newest development in the pandemic, and as many individuals are getting the vaccine, there are many concerns about experiencing negative symptoms after receiving a dose. We specifically wanted to analyze general vaccine information, looking at the distribution of the vaccines and trends in the amount of vaccines administered and the timeline of administration. We also wanted to look into the symptoms that the COVID shots have been causing to see if we could discover any trends or correlations between the symptoms and various factors such as age and previous medical history.

### Background Information
(Not sure if we want to add a part for this)


### Research Questions

These questions help us better understand the newest developments in COVID-19 data in relation to vaccines along with addressing the popular concerns that are associated with the COVID-19 vaccine.

- Which states have the highest and lowest number of Covid-19 cases and fatality rates?
- What is the most popular vaccine manufacturer in each state?
- How do Covid-19 cases compare to the number of vaccines administered per state?
- What age group has experienced the most symptoms after the vaccine?
- What is the most common symptom to experience for each manufacturer?
- How does a patient's medical history compare to their symptoms after receiving the vaccine?
- What is the trend on the number of reported adverse effect from vaccines administered per day? Does the trend differ between states and nation wide?
- What patterns are shown when looking at a patient's death (post-vaccination) and the reasons why they might have died?

### Obtaining and Cleaning the Data

The VAERSdata, VAERSsymptoms, and VAERSVax data frames came from the [Vaccine Adverse Event Reporting System's (VAERS) website](https://vaers.hhs.gov/data/datasets.html?). Each of these had about 40,000 rows with information about patients' symptoms, their vaccination record, and patient history. When a patient receives a vaccine, they receive paperwork that includes information on reporting side effects to VAERS. The patient can do this themself or if they tell a medical professional about their side effects, the medical professional will report the side effects for the patient. There is no guarantee that all side effects have been reported. In addition, information on the patient's background and receiving the vaccine is verified, but the symptoms they experienced are generally not verified. When collected, the data had last been updated on March 26th, so the rest of our data was collected to match that date.

The raw_data data frame came from the [Kaiser Family Foundation's (KFF) website](https://www.kff.org/other/state-indicator/cumulative-covid-19-cases-and-deaths/?currentTimeframe=0&sortModel=%7B%22colId%22:%22Location%22,%22sort%22:%22asc%22%7D). This gave information on the number of COVID-19 cases and the COVID-19 deaths for each state and some territories.

The cdcdoses data frame was collected from the [Centers for Disease Control and Prevention's (CDC) website](https://data.cdc.gov/browse?category=Vaccinations) and the [Bureau of the Census' website](https://data.census.gov/cedsci/). The CDC's website included the number of fully vaccinated individuals for each state. The Bureau of the Census' website gave information on population. The Bureau of the Census makes reliable predictions for populations for each state by year that are constantly updated. The predicted populations for 2021 were used as official census results have not yet been released from the 2020 census.

### Exploratory Analysis

**Which states have the highest and lowest number of Covid-19 cases and fatality rates?**

Before looking at Covid-19 vaccine data, we must first look at the U.S. map of Covid-19 cases and deaths.This will tell us how important the vaccine is for our country. It will also show where Covid-19 is contained the most and where it is uncontrolled the most. These maps give us an idea of which states might need a bigger supply of vaccines compared to others.

```{r, echo=FALSE, warning = FALSE, message = FALSE}
##Column names were not ideal with numbers,commas,dashes
raw_data2 <- raw_data
names(raw_data2)<-str_replace_all(names(raw_data2), c(" " = "."))
names(raw_data2)<-str_replace_all(names(raw_data2), c("," = "_"))
names(raw_data2)<-str_replace_all(names(raw_data2), c("-19" = ""))

#Get number of covid cases per state per 1 million people
highestCovidCasesStates <- raw_data2
highestCovidCasesStates$COVID.Cases.per.1_000_000.Population <- as.numeric(highestCovidCasesStates$COVID.Cases.per.1_000_000.Population)
highestCovidCasesStates <- highestCovidCasesStates[order(highestCovidCasesStates$COVID.Cases.per.1_000_000.Population,decreasing = TRUE),]
highestCovidCasesStates <- highestCovidCasesStates %>% filter(COVID.Cases.per.1_000_000.Population != 'N/A') %>%
  select(Location,COVID.Cases.per.1_000_000.Population)

#Join with state map data
casesStateMap <- highestCovidCasesStates %>%
  mutate("State Name" = tolower(`Location`)) %>%
  right_join(state, by = c("State Name" = "region"))

#Create map ggplot to show number of cases per 1 million per state color coded by severity
ggplot(casesStateMap, aes(x=long, y = lat, fill=COVID.Cases.per.1_000_000.Population)) + geom_polygon(aes(group=group)) + theme_map() + ggtitle("COVID-19 Cases per 1,000,000 People by State")
```

  The map shown above displays the number of Covid-19 cases per state per one million with the darker shaded states have more than the lighter shaded states. First we see that North Dakota, South Dakota, Rhode Island, Utah, and Tennessee are among the states with the highest number of Covid-19 cases per one million while Hawaii, Vermont, Puerto Rico, Maine, and Oregon are among the states with the lowest number of cases. To get this map, we first had to manipulate the column names so we could use the columns how we wanted to. Then we ordered the states by the number of Covid-19 cases per one million to see the numeric data. After doing this and joining that data with the states data to create the ggplot map of the above data.

```{r, echo=FALSE, warning = FALSE, message = FALSE}
#Get number of covid deaths per state per 1 million people
highestCovidDeathsStates <- raw_data2
highestCovidDeathsStates$COVID.Deaths.per.1_000_000.Population <- as.numeric(highestCovidDeathsStates$COVID.Deaths.per.1_000_000.Population)
highestCovidDeathsStates <- highestCovidDeathsStates[order(highestCovidDeathsStates$COVID.Deaths.per.1_000_000.Population,decreasing = TRUE),]
highestCovidDeathsStates <- highestCovidDeathsStates %>% filter(COVID.Deaths.per.1_000_000.Population != 'N/A') %>%
  select(Location,COVID.Deaths.per.1_000_000.Population)

#Join with state map data
deathsStateMap <- highestCovidDeathsStates %>%
  mutate("State Name" = tolower(`Location`)) %>%
  right_join(state, by = c("State Name" = "region"))

#Create map ggplot to show number of deaths per 1 million per state color coded by severity
ggplot(deathsStateMap, aes(x=long, y = lat, fill=COVID.Deaths.per.1_000_000.Population)) + geom_polygon(aes(group=group)) + theme_map() + ggtitle("COVID-19 Deaths per 1,000,000 People by State")
```
  
  To get this map, we first had to manipulate the column names so we could use the columns how we wanted to. Then we ordered the states by the number of Covid-19 deaths per one million to see the numeric data. After doing this and joining that data with the states data, we create the ggplot map of the above data. When looking at these maps, we can see some distinct patterns that arise. First we see that New Jersey, New York, Massachusetts, Rhode Island, and Mississippi are among the states with the highest number of Covid-19 deaths per one million while Hawaii, Vermont, Alaska, Maine, and Oregon are among the states with the lowest number of deaths. One pattern found was that for the number of Covid-19 cases, the states with the most per one million were typically in the northwest or northeast parts of the country while the number of deaths per one million due to Covid-19 were much more dispersed throughout the U.S. We can also see that there was consistency among the states with the lowest number of cases also having the lowest number of deaths with Puerto Rico being the exception. This is not the case for the states with the highest number of cases because only Rhode Island appeared in the top 5 in both categories of cases and deaths. Using this info, we can almost expect the higher cases and deaths states to receive more vaccine supply distributed to them compared to other states.

**What is the most popular vaccine manufacturer in each state?**

When learning about the vaccine distribution, an important and interesting question is, what is the most popular vaccine manufacturer in each state? This question can give us a general idea of where each vaccine is being distributed the most heavily which could help us make connections to trends in later analysis. 

```{r}
# Joining vaccine dataset with 'data' dataset, only need state, ID number, and vaccine manufacturer
#Summarizing such that the number of each type of vaccine will be counted in each state
perState <- VAERSVax %>% full_join(VAERSdata) %>%
  select(VAERS_ID, STATE, VAX_MANU) %>%
  group_by(STATE, VAX_MANU) %>%
  summarise(popular = n())

#Selecting the top vaccine distributor for each state
`%notin%` <- Negate(`%in%`)

topPerState <- top_n(perState, 1) %>%
  select(-popular)
topPerState <- na.omit(topPerState) %>%
  filter(STATE %notin% c('AS', 'Ca', 'FM', 'GU', 'MH', 'MP', 'PR', 'VI', 'XB'))

#Visualizing what manufacturers are the most distributed in different states
ggplot(topPerState, aes(x = VAX_MANU)) + geom_bar(fill = 'maroon') + xlab("Top Vaccine Manufacturers") + ylab("Number of States") + ggtitle("Number of States with Each Vaccine as the Most Distributed Vaccine")
```

The first way we responded to this question was to create a barchart to show the number of states that each vaccine is the most widely distributed in. Moderna and Pfizer were the only two vaccine manufacturers that were the most commomly administered in each state which explains why these are the only two manufacturers on the above graph. From the graph, we can see that our analysis showed that Moderna is popular in a few more states than Pfizer is. Moderna is the most widely administered vaccine in 28 states compared to Pfizer being the most administered in only 23 states. Washington D.C. was included in our analysis as a separate region which is why we looked at what appears to be 51 states. 
```{r}
#Creating a Map visualization of which states have each vaccine as the top manufacturer based on number administered
abbrev$State <- toupper(abbrev$State)

state1 <- state %>%
  select(long, lat, region, group)

state1$region <- toupper(state1$region)

stAbbrev <- state1 %>% right_join(abbrev, by = c('region' = 'State'))
stAbbrev <- stAbbrev %>%
  select(-Abbrev)

stAbbrevManu <- stAbbrev %>% right_join(topPerState, by = c('Code' = 'STATE'))

stAbbrevManu <- stAbbrevManu %>%
  mutate(VAX_MANU = as.factor(VAX_MANU))

cols <- c("darkcyan","maroon")

ggplot(stAbbrevManu, aes(x = long, y = lat)) + geom_polygon(aes(group = group, fill = VAX_MANU), color = 'grey75') + xlab("Longitude") + ylab("Latitude") + ggtitle("Top Vaccine Manufacturers by Number of Administered Doses per State") +   scale_fill_manual(values = cols) + coord_map()
```

The second visualization tool we used to respond to this question is a map of the United States with each state or district filled in by a color corresponding to Moderna or Pfizer. What we see from the map is that the vaccine manufacturers appear to be in groupings across the country, excluding a few outliers such as Minnesota, Pennsylvania, Florida, and Texas. Generally, the most common vaccine in the northern states is Moderna and the most common in the southern states is Pfizer. The first possible explanation for this trend is the location of the vaccine manufacturers. It is highly plausible that the nearest vaccine manufacturing plant to a state is the most common due to the lower costs and time of transportation and convenience. The second possible explanation involves the United States Center for Disease Control and Prevention (CDC). The CDC has had a very large part in the distribution of vaccines and they have made a lot of decisions about where and how to distribute the vaccines. It is very possible that the CDC sent large shipments of one vaccine to different areas which would explain the groupings of most common vaccines across the country.

**How do Covid-19 cases compare to the number of people fully vaccinated per state?**

We decided to investigate whether or not there was a correlation between the number of Covid-19 cases and the number of people fully vaccinated in each state. States' responses to the outbreak have varied significantly based on beliefs and leadership. 

```{r}
cases <- raw_data %>%
  inner_join(cdcdoses, by = c("Location" = "State")) %>%
  mutate("Cases per 10,000" = `Number of COVID-19 Cases`/`Population`*10000) %>%
  mutate("Fully Vaccinated per 10,000" = `Fully Vaccinated in March`/`Population`*10000)
casesmap <- cases %>%
  mutate("State Name" = tolower(`Location`)) %>%
  right_join(state, by = c("State Name" = "region"))
ggplot(casesmap, aes(x=long, y = lat, fill = `Cases per 10,000`)) + geom_polygon(aes(group=group)) + theme_map() + ggtitle("COVID-19 Cases per 10,000 People by State")
```

This map reveals the total number of Covid-19 cases for each state since the pandemic began until March adjusted for population to show the number of cases per 10,000 people.

```{r}
ggplot(casesmap, aes(x=long, y = lat, fill = `Fully Vaccinated per 10,000`)) + geom_polygon(aes(group=group)) + theme_map() + ggtitle("Number of People Fully Vaccinated per 10,000 by State")
```

This map shows the total number of fully vaccinated people for each state as of March adjusted for population to show the number of cases per 10,000 people. The maps do appear to contrast each other in a lot of places, but some states such as South Dakota, have a high number of cases and a high number of vaccinations. There are a lot of different factors that can affect a stateâ€™s number of cases and the number of people they have been able to fully vaccinate.

```{r}
sortcase <- cases %>%
  select('Location', 'Cases per 10,000')
datatable(sortcase)
```

This is a sortable data table to show the states that have had the most and least cases for their relative population. North Dakota, South Dakota, and Rhode Island have the highest cases for their population. The Northern Mariana Islands, Hawaii, and Vermont have had the least cases for their population.

```{r}
sortvac <- cases %>%
  select('Location', 'Fully Vaccinated per 10,000')
datatable(sortvac)
```

This is a sortable data table to show the states that have the least fully vaccinated people for their relative population. Utah, Puerto Rico, and Georgia have the least fully vaccinated people. Alaska, Northern Mariana Islands, and New Mexico have the most fully vaccinated people. At this point, there does not seem to be as strong correlation between total vaccinations and total cases. There are several factors impacting the number of people each state had been able to get fully vaccinated. For example, Alaska got a much larger initial shipment and Puerto Rico had difficulties with transportation for their first shipments.

**What is the most common symptom to experience for each manufacturer?**

We then wanted to further explore the Covid-19 vaccine, specifically looking for the different symptoms that each vaccine is associated with. By joining the VAERS Vaccine data with the VAERS Symptoms data, we connected manufacturer's vaccine (Moderna, Pfizer, and Janssen) with the symptoms that patients had experienced afterwards. Rather than listing every possible symptom, we chose to focus on only the top five.

```{r}
# joining vax and symptom data, only need id, vaccine manu, and symptoms
symptoms <- VAERSVax %>% full_join(VAERSsymptoms, by = 'VAERS_ID') %>%
  filter(VAX_TYPE == 'COVID19') %>%
  select(VAERS_ID, VAX_MANU, SYMPTOM1, SYMPTOM2, SYMPTOM3, SYMPTOM4, SYMPTOM5)

moderna <- symptoms %>%
  filter(VAX_MANU == 'MODERNA')
moderna <- as.data.frame(sort(table(moderna$SYMPTOM1), decreasing = TRUE) [1:5])

pfizer <- symptoms %>%
  filter(VAX_MANU == 'PFIZER\\BIONTECH')
pfizer <- as.data.frame(sort(table(pfizer$SYMPTOM1), decreasing = TRUE) [1:5])

janssen <- symptoms %>%
  filter(VAX_MANU == 'JANSSEN')
janssen <- as.data.frame(sort(table(janssen$SYMPTOM1), decreasing = TRUE) [1:5])

ggplot(moderna, aes(x = Var1, weight = Freq)) + geom_bar(fill = 'brown3') +
  ggtitle('Most Common Symptoms from Moderna Vaccine') +
  xlab('Symptom') + ylab('Count')
```

Shown above are the reported symptoms after patients had received the Moderna vaccine. The most common symptom, chill, was reported by 1,476 people at the time our data was taken, while stiffness at the site of the vaccine injection (injection site erythema) was reported by 1,319 people. The remaining top symptoms include arthralgia (joint pain), headaches, and dizziness. Overall, symptoms from the Moderna vaccine seem relatively mild.

```{r}
ggplot(pfizer, aes(x = Var1, weight = Freq)) + geom_bar(fill = 'brown3') +
  ggtitle('Most Common Symptoms from Pfizer Vaccine') +
  xlab('Symptom') + ylab('Count')
```

When looking at the symptoms from the Pfizer vaccine pictured above, we found that the symptoms that people had experienced were somewhat similar to those from the Moderna vaccine. Again, the top symptom reported was chills with 1,421 counts, this time followed by 957 reports of arthralgia. The other top symptoms include headaches, dizziness, and Covid-19 itself which was an interesting observation. However, we can't assume Covid-19 in the patient was caused by the vaccine and one possible reason for this to occur as a symptom may have been that the patient already had Covid-19 before receiving the vaccine.

```{r}
ggplot(janssen, aes(x = Var1, weight = Freq)) + geom_bar(fill = 'brown3') +
  ggtitle('Most Common Symptoms from Janssen Vaccine') +
  xlab('Symptom') + ylab('Count')
```

Finally, we looked at the Janssen vaccine (also known as Johnson & Johnson's vaccine). Although there is less data than the Moderna and Pfizer vaccinations, we again found a similar trend in the symptoms. Like the previous vaccines, chills was the most commonly reported vaccine, which 361 patients experienced after the Janssen vaccine. The remaining top symptoms, including arthralgia, fatigue, pyrexia (fever), and headaches, were reported at a much lower count.

**What age group has experienced the most symptoms after the vaccine?**

```{r}
# joining general patient data and vax data
age <- VAERSdata %>% full_join(VAERSVax, by = 'VAERS_ID') %>%
  select(VAERS_ID, VAX_MANU, AGE_YRS)
# adding 10 year age group column to sort ages
age <- age %>%
  mutate(AGE_GROUP = ifelse(AGE_YRS %in% 0:18, '0 to 18',
                     ifelse(AGE_YRS %in% 19:29, '19 to 29',
                     ifelse(AGE_YRS %in% 30:39, '30 to 39',
                     ifelse(AGE_YRS %in% 40:49, '40 to 49',
                     ifelse(AGE_YRS %in% 50:59, '50 to 59',
                     ifelse(AGE_YRS %in% 60:69, '60 to 69',
                     ifelse(AGE_YRS %in% 70:79, '70 to 79',
                     ifelse(AGE_YRS %in% 80:89, '80 to 89', 'Over 90')))))))))
# plotting visual representation
ggplot(age, aes(x = AGE_GROUP)) + geom_bar(fill = 'darkslateblue') +
  ggtitle('Number of Vaccinations per Age Groups') +
  xlab('Age Group (years)') + ylab('Count')
```

To determine if there was a correlation between age and the likelihood of experiencing symptoms, we joined the VAERS data with the VAERS Vaccine data and split the patients into different age groups. This returned a graph with the counts of people who have experienced symptoms in each age group (divided into people under 18 followed by 10 year increments). We found that the people between 30 and 39 years old had experienced the most symptoms compared to other ages (6,083 people). On the other hand, only 242 people aged 18 years and younger were reported to have experienced symptoms. However, the low number of observations may be due to the fact that many younger people weren't eligible for the vaccine for the first few months of distribution because older people and those with health conditions were prioritized first, so there might just be a lack of data. Finally, when looking at the overall trend of the bar graph, we notice a sharp increase to the '30 to 39' age group followed by a gradual decline until it increases at the 'Over 90' group which is everyone over 99 years old that experienced symptoms.

**How does a patient's medical history compare to their symptoms after receiving the vaccine?**

In addition to learning about the specific symptoms after receiving the vaccine and further analyzing the effects of age on experiencing symptoms, we wanted to discover whether there were common trends between a patient's medical history and symptoms that they experienced with the vaccine. 

```{r}
#Join VAERSsymptoms and VAERSdata, only need ID, all 5 symptoms, and patient history
#Then cleaning the history column to create uniformity
medHist <- VAERSsymptoms %>% full_join(VAERSdata) %>%
  select(VAERS_ID, SYMPTOM1, SYMPTOM2, SYMPTOM3, SYMPTOM4, SYMPTOM5, HISTORY) %>%
  separate(HISTORY, c('history1', 'history2', 'history3', 'history4', 'history5', 'history6', 'history7', 'history8',
                      'history9', 'history10'), sep = ', ') %>%
  mutate(history1 = tolower(history1),
         history2 = tolower(history2),
         history3 = tolower(history3),
         history4 = tolower(history4),
         history5 = tolower(history5),
         history6 = tolower(history6),
         history7 = tolower(history7),
         history8 = tolower(history8),
         history9 = tolower(history9),
         history10 = tolower(history10))

#Summarising medical history to find how often each history diagnosis appears in the dataset
medHist2 <- medHist %>%
  pivot_longer(history1:history10, names_to='histName', values_to='conditionHist') %>%
  group_by(conditionHist) %>%
  summarise(count = n())

#Creating a negation of the %in% to use in analysis
`%notin%` <- Negate(`%in%`)

#Finding the top 10, not including 5 null or 'none', medical history conditions
topHist <- top_n(medHist2, 18) %>%
  filter(conditionHist %notin% c('none',
  'comments: list of non-encoded patient relevant history: patient other relevant history 1: none', 'n/a', 'no',
  'unknown', 'medical history/concurrent conditions: no adverse event (no reported medical history)'))
topHist <- na.omit(topHist)

topHist <- topHist %>%
  mutate(conditionHist = if_else(conditionHist == 'htn', 'hypertension', conditionHist))

topHist[8,2] <- topHist[8,2] + topHist[10,2]

topHist <- topHist[-10, ]

#Filtering the medical history dataset such that I only have the top 10 medical conditions and the covid vaccination symptoms of those conditions
medHist3 <- medHist %>%
  filter(history1 %in% c('anxiety', 'asthma', 'copd', 'depression', 'diabetes', 'gerd', 'high blood pressure',
                         'hypertension', 'htn', 'hyperlipidemia', 'hypothyroidism')) %>%
  select(-history2, -history3, -history4, -history5, -history6, -history7, -history8, -history9, -history10) %>%
  rename('MedHist' = 'history1')

medHist3 <- medHist3 %>%
  mutate(MedHist = if_else(MedHist == 'htn', 'hypertension', MedHist))

#Learning about what the top symptoms are for each medical history
symptom1 <- medHist3 %>%
  group_by(MedHist, SYMPTOM1) %>%
  summarise(symptomCount = n())
symptom1 <- na.omit(symptom1)

symptom2 <- medHist3 %>%
  group_by(MedHist, SYMPTOM2) %>%
  summarise(symptomCount = n())
symptom2 <- na.omit(symptom2)

symptom3 <- medHist3 %>%
  group_by(MedHist, SYMPTOM3) %>%
  summarise(symptomCount = n())
symptom3 <- na.omit(symptom3)

symptom4 <- medHist3 %>%
  group_by(MedHist, SYMPTOM4) %>%
  summarise(symptomCount = n())
symptom4 <- na.omit(symptom4)

symptom5 <- medHist3 %>%
  group_by(MedHist, SYMPTOM5) %>%
  summarise(symptomCount = n())
symptom5 <- na.omit(symptom5)

#Selecting only the top symptom for each medical history condition for each symptom dataset
symptom1 <- top_n(symptom1, 1)
symptom2 <- top_n(symptom2, 1)
symptom3 <- top_n(symptom3, 1)
symptom4 <- top_n(symptom4, 1)
symptom5 <- top_n(symptom5, 1)

#Joining datasets to create only one symptom dataset with the top symptoms from each symptom 1-5
allSympt <- symptom1 %>% full_join(symptom2)
allSympt <- allSympt %>% full_join(symptom3)
allSympt <- allSympt %>% full_join(symptom4)
allSympt <- allSympt %>% full_join(symptom5)

#Selecting only the top symptoms when comparing symptoms 1-5
topAllSympt <- top_n(allSympt, 1, symptomCount) %>%
  select(MedHist, SYMPTOM1, SYMPTOM2, SYMPTOM3, SYMPTOM4, SYMPTOM5)
head(topAllSympt, 10)
```
To learn more about the relationship between medical history and symptoms after receiving the vaccine, we first had to make a decision about how to analyze the medical history. The dataset was not organized nicely such that running analysis on the medical history would be easy. The first step we took to clean the data is we had to separate the long strings of written notes about the history into categories called History1, History2,..., History10 so that we could have a more unified column of medical history. Then, we summarized to find the 10 most common medical history conditions. Those conditions were anxiety, asthma, chronic obstructive pulmonary disease (COPD), diabetes, gerd, high blood pressure, hyperlipidemia, hypertension, hypothyroidism, and depression. After finding the top 10 most common medical history conditions, we could look at the most common symptoms for those 10 conditions. This required us to manipulate the dataframe even further so that we could summarize by the most frequent symptoms in each of the symptom categories (1-5) and then compare the most common symptom among all 5 symptom categories. The result is printed in the table above. Chills was by far the most common symptom to experience when comparing the most common medical history conditions as out of the 10 conditions, 7 of the most common symptom was chills. The remaining three most common symptoms were death, injection site erythema, and headache. Another note about the most common symptoms is that 9 of the 10 most common symptoms to experience for each condition were found in the SYMPTOM1 column. This is most likely because the symptom that was either the most prominent or the only symptom was the first or only symptom recorded, causing it to appear in the SYMPTOM1 column in our analysis. 


**What is the trend on the number of reported adverse effect from vaccines administered per day? Does the trend differ between states and nation wide?**

To find if there are any trends in the data, we started off by joining the VAERSdata and the VAERSVax data in order to have both the date and the state in one data frame. Once we had all of the data columns we had to filter our any data that did not have to do with Covid-19. We also found that there were some dates from before 2018 that must have been mistakes to we also filtered those out.

Now we could look into any trends in the number of reports based on the date. We started off using all the samples in order to get a graph of the trend nation wide.

```{r}
# Date frame that has vaccine date, and the state it was administered in
vaxinfo <- VAERSdata %>%
    inner_join(VAERSVax, by = "VAERS_ID") %>%
    mutate(VAX_DATE = as.Date(VAX_DATE)) %>%
    filter(VAX_TYPE == "COVID19",
           VAX_DATE > as.Date("2018-01-01"),
           !is.na(STATE)) %>%
    select(VAERS_ID, VAX_DATE, STATE)


# Data frame with total of report per day
vaxinfo_daily <- vaxinfo %>%
    group_by(VAX_DATE) %>%
    summarise(DAILY_TOTAL = n())

# Data frame with total of report per day based on state
vaxinfo_daily_state <- vaxinfo %>%
    group_by(VAX_DATE, STATE) %>%
    summarise(DAILY_TOTAL = n())

# Total number of reports per state, and peak date of reports
vaxinfo_state <- vaxinfo %>%
    group_by(STATE) %>%
    summarise(TOTAL = n(), PEAK = mean(VAX_DATE))



vaxinfo_daily %>%
    filter(VAX_DATE > as.Date("2021-01-01")) %>%
    ggplot(aes(x = VAX_DATE, y = DAILY_TOTAL, color = "red")) +
    geom_line() +
    xlab("Date") +
    ylab("Number of reports") +
    ggtitle("Reports of adverse effects from vaccines in 2021")
```

Now we wanted to see what the trends looked like on a state level. To do this we grouped the rows by state and could then plot a specific state. We decided to just look at the top 10 states that has the highest numbers of reports.

```{r}
sorted_states <- vaxinfo_state %>% arrange(TOTAL) %>% select(STATE, TOTAL)
#tail(sorted_states, 10)

vaxinfo_daily_state %>%
    filter(VAX_DATE > as.Date("2020-12-01"), STATE %in% tail(sorted_states$STATE, 10)) %>%
    ggplot(aes(x = VAX_DATE, y = DAILY_TOTAL, color = STATE)) +
    geom_line() +
    facet_wrap(.~STATE) +
    xlab("Date reported") +
    ylab("Daily cases reported") +
    ggtitle("States with the most number of reports")
```

We also created a choropleth map to visualize the number of reports each state had, as well as a map to show when the peak date of the number of reports.

```{r}
# Get data in the same format so they can be joined
cdcdoses1 <- cdcdoses %>%
    mutate(State = tolower(State), Vaccinated = `Fully Vaccinated in March`)

# Join state names, abbreviations, vaccine doses, and map data
dat <- abbrev %>%
    mutate(State = tolower(State)) %>%
    left_join(state, by = c("State" = "region")) %>%
    right_join(vaxinfo_state, by = c("Code" = "STATE")) %>%
    right_join(cdcdoses1, by = "State")


ggplot(dat, aes(x = long, y = lat)) +
    geom_polygon(aes(group = group, fill = TOTAL / Vaccinated), color = "white", size = 0.1) +
    scale_fill_gradient(low = "#01c40e", high = "#ff0000") +
    coord_map() +
    theme_map() +
    ggtitle("Reports adjusted for number of vaccines administered")

ggplot(dat, aes(x = long, y = lat, group = group, fill = PEAK)) +
    geom_polygon(color = "white", size = 0.1) +
    coord_map() +
    theme_map() +
    ggtitle("Peak date of reports")
```

**What patterns are shown when looking at a patient's death (post-vaccinnation) and the reasons why they might have died?**

Now that we have looked at how many people have experienced adverse effects from the vaccine since they have been released, we will now look at the data of people who died after receiving the vaccine and reported adverse effects from the vaccine. Doing this, we will analyze the reasons why they may have died and the relation of those reasons to the vaccine effects. We first had to filter the VAERSdata set to only look at people who have died. Then we looked at 3 main factors: Age, Gender, and symptoms experienced after the vaccine to see the commonalities among these people who died after receiving the vaccine. 

```{r, echo=FALSE, warning = FALSE, message = FALSE}
#Age
deathAfterVax <- VAERSdata %>% filter(DIED=='Y')
deathAfterVaxAge <- deathAfterVax %>% count(AGE_YRS)
ggplot(deathAfterVaxAge,aes(x=AGE_YRS,y=n)) + geom_col() + ggtitle("Deaths after Vaccine by Age") + xlab("Age") + ylab("Number of Deaths after receiving a vaccine")
```

  This graph shows the distribution of the number of people who died after receiving the vaccine by age. As you can see, the vast majority  of people who died are over the age of 75, so old age seems to be a factor for survival rate after the vaccine dose. 

```{r, echo=FALSE, warning = FALSE, message = FALSE}
#Gender
deathAfterVaxSex <- deathAfterVax %>% count(SEX) %>% filter(SEX !='U')
ggplot(deathAfterVaxSex,aes(x=SEX,y=n)) + geom_col() + ggtitle("Deaths after Vaccine by Gender") + xlab("Gender") + ylab("Number of Deaths after receiving a vaccine")
```

  This graph shows the distribution of the number of people who died after receiving the vaccine by gender. As you can see, the majority of people who died are male, so gender seems to be a slight factor for survival rate after the vaccine dose. Some patients had an undefined gender so we kept those out of this data because it was just a small amount of people that most likely would not have a big impact on the results we found.

```{r, echo=FALSE, warning = FALSE, message = FALSE}
#Common symptoms after vax in deaths
deathSymptoms <- deathAfterVax %>% left_join(VAERSsymptoms, by = 'VAERS_ID') %>% group_by(VAERS_ID) %>%
  select(VAERS_ID, AGE_YRS, SEX, SYMPTOM1, SYMPTOM2, SYMPTOM3, SYMPTOM4, SYMPTOM5)

deathSymptoms1 <- deathSymptoms %>% count(SYMPTOM5) %>% arrange(desc(n), .by_group = TRUE)
deathSymptoms1 <- as.data.frame(sort(table(deathSymptoms1$SYMPTOM5), decreasing = TRUE) [1:11])
deathSymptoms1 <- deathSymptoms1[c(2,3,4,5,6,7,8,9,10,11),]#The other rows are unrelated symptoms to our research

ggplot(deathSymptoms1, aes(x = Var1, weight = Freq)) + geom_bar(fill = 'steelblue') +
  ggtitle('Most Common Symptoms from People who died after receiving a Covid Vaccine') +
  xlab('Symptom') + ylab('Count') + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

  This graph shows the distribution of the number of people who died after receiving the vaccine by symptom. The graph shows the top 10 symptoms experienced after the vaccine. We had to weed out a few of the results like 'Death' because that is already assumed given the data. There was also duplicate/similar data that we took into consideration. Some extra quick Google research had to be done to understand the medical terms used for the most common symptoms. For example, Dysponea means shortness of breath, Pyrexia means fever, Syncope meaning unconsciousness, and Hypoxia is insufficient oxygen supply. After understanding those, we concluded that the following 10 symptoms shown leads to a greater chance of death than other symptoms experienced after receiving the vaccine. In addition, being over the age of 75 and male puts you also at a greater risk to die after the vaccine.

### Challenges Faced

One of the first challenges that we faced was that our questions that we had proposed did not line up with the data that we had. Once we had started doing data analysis we realized that what was in the data would not be able to answer the original question. In order to remedy that problem, we re-framed the original question so that we could answer it with the data that we had collected.

The next challenge that we faced was working with the data. We used multiple different data sets, some of which had multiple different sheets. This meant that to answer the questions we had, a lot of the time we would have to combine data sets that had information that pertained to it. Many times that data was not in the same format, so we would have to mutate it into a format that match. Another issue with the data was that it was not always in a structured format. This meant that we had to parse the data manually and extract the important information in whatever format it was in. One example of this was in the data about the patients with Covid-19. We wanted to look at the symptoms that they had, but the all the information was notes from the doctors in a single string. The notes has not format or structure, so to get a list of symptoms we had to parse that string.

### Conclusion

The Covid-19 pandemic has affected virtually everyone of all age groups on earth since March 2020. Children and teens couldn't attend school the way they normally would, adults struggled with the stresses of keeping themselves and their families healthy and unemployment, and older people had to take extra care to avoid the virus. These struggles led to a push for a vaccine as soon as possible but also as safe as possible. Fortunately, the first release of the Covid-19 vaccine arrived in December of 2020, about twelve months since the first Covid-19 case and nine months since the first lockdown in the United States, with it becoming more and more available to the general public in the U.S., although certainly not without some minor health complications.

After comparing Covid-19 cases/deaths and vaccinations in each state in the U.S., we then began to look closer at the symptoms associated with each vaccine, along with any differences among age groups. According to our analyses, the Moderna, Pfizer, and Janssen vaccines had come with minor symptoms of their own, the most common including chills, arthralgia, and headaches. Additionally, we looked for trends between a patient's medical history and symptoms that they had experienced, along with any trends that may have occured by state. Finally, we looked deeper into our data and focused more on symptoms that correlated with patients who had died after receiving a vaccine, and found that these included weakness, cardiac arrest, difficulty breathing, and fever. Although there are definitely major symptoms associated with each manufacturer's vaccine, our study does not conclude that these are specifically caused by the Covid-19 vaccine. Because of this, we do encourage people to get vaccinated if they are able to do so, as the world would sooner be able to return to the "normal" everyone has been waiting for.

### Personal Contributions
#### **Zack Larson**
  I contributed to this project by first helping explore datasets for our topic along with coming up with research questions to use in our exploratory analysis. I completed the analysis on the number of Covid-19 cases and deaths per state along with analyzing what patterns are shown when looking at a patient's death (post-vaccination) including the reasons why they might have died. My work can be found under each of my commits to the master branch under my Github username Zclarson.
  
#### **Dana Thacker**
  My contributions to this project included helping to select the topic of Covid-19 Vaccine data and discussing with group members to decide specifically what questions to analyze. The questions I analyzed in RStudio were the distribution of vaccines among states and the relationship between a patient's medical history and their post-vaccine symptoms. I also played a large role in coordinating meetings outside of class via Zoom for our group to discuss our progress on the project. Finally, I compiled all of the group members pre-recorded videos discussing their questions for the presentation and created the final mp4 file that was presented to the class.
  
#### **Nikole Slinger**
  For this project, I contributed by helping search for and exploring the data sets to work with, coming up with questions for the group to answer, and helping with the project proposal. My analysis focused on searching for symptoms that each manufacturers' vaccine were correlated with and comparing them to each other. I also looked at different age groups and how they were affected differently and attempted to find explanations for these differences. Finally, I made connections and conclusions by combining what each of my groupmates found through their own analysis. My specific analysis can be found under my commits to the master branch under the Github username nikoles10.

### Works Cited

1. Covid cases by state: https://www.kff.org/other/state-indicator/cumulative-covid-19-cases-and-deaths/?currentTimeframe=0&sortModel=%7B%22colId%22:%22Location%22,%22sort%22:%22asc%22%7D

2. Covid Vaccine Side Effect data (VAERS Data, Symptoms, and Vaccine datasets from 2021): https://vaers.hhs.gov/data/datasets.html

3. Covid Fully Vaccinated Counts: https://data.cdc.gov/browse?category=Vaccinations

4. Population Counts: https://data.census.gov/cedsci/








